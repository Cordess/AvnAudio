@page "/"
@inject IBlazorFileSaver BlazorFileSaver

<PageTitle>Audio Recorder Wasm Demo</PageTitle>

<h1>Audio Recorder</h1>

<AudioRecorder @ref="audioRecorder"
               SampleRate=@SampleRate
               Channels=@Channels
               TimeSlice=@TimeSlice
               BufferRecorded="AudioBufferRecorded"
               RecordingStarted="RecordingStarted"
               RecordingStopped="RecordingStopped"
               InputDevices="AudioInputDevices"
               AudioStatusChanged="AudioStatusChanged" />

<button class="btn btn-primary" @onclick="EnumerateDevices">Enumerate Devices</button>

<button disabled="@RecordButtonDisabled" class="btn btn-primary" @onclick="StartRecording">Start Recording</button>
<button disabled="@StopRecordButtonDisabled" class="btn btn-primary" @onclick="StopRecording">Stop Recording</button>


<p>@Status</p>

<h5>Input Devices</h5>
<select size="16" style="width:100%;" @onchange="InputDeviceSelected">
    @foreach (var device in AudioInputDevices)
    {
        <option value="@device.deviceId">@device.label</option>
    }
</select>

@code {
    // Change these values to play around with 
    // audio settings
    int Channels = 1;           // 1=mono, 2=stereo
    int SampleRate = 44100;     // values: 6000, 8000, 11025, 16000, 22050, 32000, 44100, 48000
    int TimeSlice = 1000;       // time in ms between each buffer

    // Reference to the component
    AudioRecorder audioRecorder { get; set; }

    // We need to have a local list of BrowserMediaDevice to provide as a parameter
    List<BrowserMediaDevice> AudioInputDevices { get; set; } = new List<BrowserMediaDevice>();
    
    string Status = string.Empty;           // Displayed in the UI
    bool RecordButtonDisabled = true;       // for enabling/disabling the record button
    bool StopRecordButtonDisabled = true;   // for enabling/disabling the stop button
    string SelectedInputDeviceId = null;    // id of the selected recording device
    MemoryStream AudioDataStream;           // In-memory stream for audio data (WASM compatible)
    long BytesRecorded = 0;                 // We keep track of total bytes recorded

    // Stop button clicked
    async Task StopRecording()
    {
        await audioRecorder.StopRecording();

        RecordButtonDisabled = false;
        StopRecordButtonDisabled = true;
    }

    // Occurs when a new buffer arrives
    void AudioBufferRecorded(AudioBuffer buffer)
    {
        if (AudioDataStream != null && AudioDataStream.CanWrite)
        {
            // Write the data to the memory stream
            AudioDataStream.Write(buffer.Data, 0, buffer.Data.Length);
            BytesRecorded += buffer.Data.Length;
            // Update the status
            Status = $"Received {buffer.Data.Length} bytes (Total: {BytesRecorded:N0} bytes) at {DateTime.Now.ToLongTimeString()}";
            StateHasChanged();
        }
    }

    // Occurs when recording starts
    void RecordingStarted()
    {
        // You can do something here to indicate recording
    }

    // Occurs when the recording stops
    async Task RecordingStopped()
    {
        Status = $"Recording Stopped - Total: {BytesRecorded:N0} bytes recorded";

        if (AudioDataStream != null && BytesRecorded > 0)
        {
            // Get the recorded data from memory stream
            var bytes = AudioDataStream.ToArray();
            Status = $"Saving {bytes.Length:N0} bytes...";
            StateHasChanged();

            // save the file, and it downloads automatically.
            await BlazorFileSaver.SaveAsBase64("Recorded.webm", Convert.ToBase64String(bytes), "audio/webm");

            Status = $"File saved successfully! ({bytes.Length:N0} bytes)";

            // Clean up
            AudioDataStream.Dispose();
            AudioDataStream = null;
        }
        else
        {
            Status = "Error: Recording stopped but no data was recorded! Check browser console for details.";
        }

        StateHasChanged();
    }

    // The Record button was clicked
    async Task StartRecording()
    {
        if (string.IsNullOrEmpty(SelectedInputDeviceId))
        {
            Status = "Error: Please select a microphone first!";
            StateHasChanged();
            return;
        }

        BytesRecorded = 0;  // initialize

        // Clean up any existing stream
        if (AudioDataStream != null)
        {
            AudioDataStream.Dispose();
        }

        // Create a new memory stream for recording (WASM compatible)
        AudioDataStream = new MemoryStream();

        // DEBUG: Log the selected device ID
        Status = $"Starting recording with deviceId: {SelectedInputDeviceId}";
        StateHasChanged();

        // Tell the AudioRecorder component to start recording
        await audioRecorder.StartRecording(SelectedInputDeviceId);

        // Enable/disable buttons
        RecordButtonDisabled = true;
        StopRecordButtonDisabled = false;

        Status = "Recording in progress...";
        StateHasChanged();
    }

    // Occurs when the user selects an input device
    void InputDeviceSelected(ChangeEventArgs args)
    {
        // Set the selected input device id
        SelectedInputDeviceId = args.Value.ToString();
        // Enable the record button
        RecordButtonDisabled = false;
    }

    // The user has clicked the Enumerate Devices button
    async Task EnumerateDevices()
    {
        // tell the AudioRecorder component to enumerate devices
        await audioRecorder.EnumerateDevices();
    }

    // Occurs when the audio status has changed
    void AudioStatusChanged(string status)
    {
        Status = status;
    }
}
